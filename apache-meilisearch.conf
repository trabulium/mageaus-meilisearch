# Meilisearch Apache Configuration
# Add this to your Maho site's VirtualHost configuration

# Enable required modules (add to apache2.conf or load in your VirtualHost)
# a2enmod proxy
# a2enmod proxy_http
# a2enmod headers
# a2enmod rewrite

<IfModule mod_proxy.c>
    # Meilisearch proxy configuration
    <Location /meilisearch/>
        # Proxy to local Meilisearch instance
        ProxyPass http://localhost:7700/
        ProxyPassReverse http://localhost:7700/

        # Add API key authorization (IMPORTANT: Replace with your actual API key)
        RequestHeader set Authorization "Bearer YOUR_MEILISEARCH_API_KEY_HERE"

        # Standard proxy headers
        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "https" env=HTTPS

        # CORS headers for frontend access
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"

        # Handle preflight requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=204,L]

        # Timeout settings
        ProxyTimeout 10

        # Disable authentication if your site uses it
        Satisfy Any
        Allow from all
    </Location>

    # Handle OPTIONS requests globally for CORS
    <If "%{REQUEST_METHOD} == 'OPTIONS'">
        Header always set Access-Control-Max-Age "1728000"
        Header always set Content-Type "text/plain; charset=utf-8"
        Header always set Content-Length "0"
    </If>
</IfModule>

# Rate limiting (optional - requires mod_ratelimit or mod_evasive)
# <IfModule mod_ratelimit.c>
#     <Location /meilisearch/>
#         SetOutputFilter RATE_LIMIT
#         SetEnv rate-limit 400
#     </Location>
# </IfModule>

# Alternative: Using mod_evasive for rate limiting
# <IfModule mod_evasive20.c>
#     DOSHashTableSize 3097
#     DOSPageCount 10
#     DOSSiteCount 50
#     DOSPageInterval 1
#     DOSSiteInterval 1
#     DOSBlockingPeriod 10
#     DOSWhitelist 127.0.0.1
# </IfModule>

# IMPORTANT SECURITY NOTE:
# This configuration proxies requests from /meilisearch/ on your domain to the local
# Meilisearch server. The API key is added server-side, so it's never exposed to clients.
# This allows frontend JavaScript to make requests to /meilisearch/ without needing
# to embed the API key in client-side code.
#
# Make sure to:
# 1. Replace YOUR_MEILISEARCH_API_KEY_HERE with your actual Meilisearch API key
# 2. Keep your Meilisearch server (port 7700) blocked from external access
# 3. Only allow access through this Apache proxy
# 4. Restart Apache after making changes: sudo systemctl restart apache2
