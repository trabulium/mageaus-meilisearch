# Meilisearch Nginx Configuration
# Add this to your nginx.conf http block for rate limiting (optional but recommended)

# In the http block of /etc/nginx/nginx.conf:
# limit_req_zone $binary_remote_addr zone=meilisearch:10m rate=10r/s;

# Then add this location block to your Maho site's server block:

location /meilisearch/ {
    # Completely disable authentication for this location
    # (Important if your site uses HTTP basic auth)
    satisfy any;
    allow all;
    auth_basic off;

    # Remove /meilisearch prefix before proxying
    rewrite ^/meilisearch/(.*)$ /$1 break;

    # Proxy to local Meilisearch instance
    proxy_pass http://localhost:7700;

    # Add API key authorization (IMPORTANT: Replace with your actual API key)
    proxy_set_header Authorization "Bearer YOUR_MEILISEARCH_API_KEY_HERE";

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # CORS headers for frontend access
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
    }

    # Rate limiting (optional - requires limit_req_zone defined in nginx.conf)
    limit_req zone=meilisearch burst=20 nodelay;

    # Timeout settings
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
}

# IMPORTANT SECURITY NOTE:
# This configuration proxies requests from /meilisearch/ on your domain to the local
# Meilisearch server. The API key is added server-side, so it's never exposed to clients.
# This allows frontend JavaScript to make requests to /meilisearch/ without needing
# to embed the API key in client-side code.
#
# Make sure to:
# 1. Replace YOUR_MEILISEARCH_API_KEY_HERE with your actual Meilisearch API key
# 2. Keep your Meilisearch server (port 7700) blocked from external access
# 3. Only allow access through this nginx proxy
